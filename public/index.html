<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Stream Room</title>
  <style>
    video { width: 45%; margin: 10px; background: #000; }
    #videos { display: flex; justify-content: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Tạo phòng Live Stream</h1>
  <!-- Form xác minh tài khoản -->
  <form id="createRoomForm">
    <label for="verificationToken">Verification Token:</label>
    <input type="text" id="verificationToken" name="verificationToken" required>
    <button type="submit">Tạo Phòng</button>
  </form>

  <div id="roomInfo"></div>

  <!-- Video demo -->
  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const createRoomForm = document.getElementById('createRoomForm');
    const roomInfo = document.getElementById('roomInfo');
    let roomId;

    createRoomForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = document.getElementById('verificationToken').value;
      try {
        const res = await fetch('/livestream/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ verificationToken: token })
        });
        const data = await res.json();
        if (data.success) {
          roomId = data.roomId;
          roomInfo.innerHTML = `<p>Phòng live stream của bạn: ${roomId}</p>`;
          // Tham gia phòng qua Socket.IO
          socket.emit('joinRoom', roomId);
        } else {
          roomInfo.innerHTML = `<p style="color:red;">${data.error}</p>`;
        }
      } catch (error) {
        console.error("Error:", error);
        roomInfo.innerHTML = `<p style="color:red;">Lỗi xảy ra, hãy thử lại sau.</p>`;
      }
    });

    // Xử lý sự kiện join room
    socket.on('userJoined', data => {
      console.log("User joined:", data);
    });

    // Xử lý signaling nếu cần
    socket.on('signal', data => {
      console.log("Signal received:", data);
    });

    // Giả lập getUserMedia để hiển thị local stream (ví dụ)
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        document.getElementById('localVideo').srcObject = stream;
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
