<%# File: views/liveRoom.ejs %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live: <%= roomTitle %></title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/css/liveRoom.css">
    <link rel="icon" type="image/png" href="https://cdn.glitch.global/71030012-56ea-4d26-a426-e0099201df1c/823029_library_512x512.png?v=1741523759119">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body class="live-room-body">
    <div class="live-room-background">
        <div id="live-particles-bg"></div>
        <div class="gradient-flare flare-1"></div>
        <div class="gradient-flare flare-2"></div>
    </div>

    <header class="live-room-main-header">
        <div class="header-info">
            <i class="fas fa-podcast stream-live-icon"></i>
            <h1 class="live-room-title">
                <span class="stream-title-text"><%= roomTitle %></span>
                <span class="host-info">Host: <%= roomOwner %></span>
            </h1>
        </div>
        <div class="header-stats">
            <div class="viewer-count-widget">
                <i class="fas fa-eye"></i>
                <span id="viewerCountLive" class="viewer-count-live">0</span>
            </div>
            <!-- Viewer's button to toggle their LOCAL whiteboard display -->
            <button id="toggleQuizGlobalVisibilityBtn" class="control-btn" title="Bật/Tắt trắc nghiệm cho người xem">
                <i class="fas fa-question-circle"></i> <span class="btn-text">Hiện Trắc Nghiệm</span>
            </button>
            <button id="viewerToggleWhiteboardDisplayBtn" class="control-btn wb-viewer-toggle-btn" title="Hiện bảng vẽ (nếu chủ phòng đang bật)" disabled>
                <i class="fas fa-chalkboard"></i> <span class="btn-text">Bảng Vẽ</span>
            </button>
            <button id="exitRoomBtnLive" class="exit-room-btn-v2" title="Rời phòng">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </header>

    <main class="live-room-main-content">
        <section class="live-video-area">
            <div class="video-player-wrapper">
                <video id="liveVideoFeed" class="live-video-element" playsinline autoplay></video>
                <div id="streamPlaceholder" class="stream-video-placeholder <%= isHostPresent ? '' : 'active' %>">
                    <div class="placeholder-content">
                        <i class="fas fa-photo-video placeholder-icon"></i>
                        <p>Stream đang chờ hoặc đã kết thúc.</p>
                        <span>Vui lòng chờ đợi hoặc thử lại sau.</span>
                    </div>
                </div>
                <span id="liveIndicator" class="stream-live-indicator <%= isHostPresent ? 'active' : '' %>">LIVE</span>
            </div>
        </section>

        <aside class="live-chat-area">
            <div class="live-chat-container">
                <div class="chat-area-header">
                    <i class="fas fa-comments"></i>
                    <span>Live Chat</span>
                </div>
                <div id="pinnedCommentLive" class="pinned-comment-live">
                    <%# Pinned comment injected by JS %>
                </div>
                <div class="chat-messages-container">
                    <ul id="chatMessagesLive" class="chat-messages-list-v2">
                        <%# Chat messages appended here %>
                    </ul>
                </div>
                <div class="chat-input-footer">
                    <div id="chatPreviewLive" class="chat-preview-live prose-styling"></div>
                    <div class="chat-input-wrapper">
                        <textarea id="chatInputAreaLive" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                        <button id="sendChatBtnLive" class="send-chat-btn-v2" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Overlays -->
    <div id="waitingOverlayLive" class="live-status-overlay <%= isHostPresent ? '' : 'active' %>">
        <div class="overlay-content">
            <div class="overlay-spinner"><div></div><div></div><div></div></div>
            <h2>Đang chờ Streamer...</h2>
            <p>Buổi live sẽ sớm bắt đầu. Vui lòng chờ trong giây lát.</p>
        </div>
    </div>

    <div id="playOverlayLive" class="live-status-overlay play-overlay">
        <div class="overlay-content">
            <button id="playButtonLive" class="play-action-btn" title="Phát Video">
                <i class="fas fa-play"></i>
            </button>
            <p>Nhấn để bắt đầu xem stream</p>
        </div>
    </div>

    <div id="roomEndedOverlayLive" class="live-status-overlay ended-overlay">
        <div class="overlay-content">
            <span class="overlay-icon"><i class="fas fa-sad-tear"></i></span>
            <h2>Buổi Live Đã Kết Thúc</h2>
            <p>Cảm ơn bạn đã tham gia! Streamer đã kết thúc buổi phát sóng này.</p>
            <a href="<%= glitchProjectUrl %>/live" class="control-btn overlay-action-btn" style="background: var(--primary-color); color: white; max-width: 200px; margin: 0 auto;">
                <i class="fas fa-home"></i> Về Trang Live
            </a>
        </div>
    </div>

    <!-- Viewer Whiteboard Overlay -->
    <!-- Changed ID from whiteboardContainerOverlayViewer to sharedWhiteboardOverlayViewer to match CSS -->
    <div id="sharedWhiteboardOverlayViewer" class="whiteboard-container-overlay viewer-wb" style="display: none;">
        <!-- Toolbar for the VIEWER -->
        <div id="whiteboardToolbarViewer" class="whiteboard-toolbar">
            <!-- Viewer controls are typically limited. Streamer has full controls. -->
            <!-- If viewer CAN draw, they might have color/linewidth. -->
            <!-- For simplicity, let's assume viewer has minimal controls. -->
            <button id="wbCloseBtnViewer" class="control-btn wb-tool-btn" title="Đóng Bảng Vẽ">
                <i class="fas fa-times"></i>
            </button>
            <span id="wbCoordsDisplayViewer" class="whiteboard-coords-display" style="display:none;"></span>
            <!-- Add other viewer-specific buttons here if needed, e.g., zoom -->
             <button id="wbZoomInBtnViewer" class="control-btn wb-tool-btn" title="Phóng to">
                <i class="fas fa-search-plus"></i>
            </button>
            <button id="wbZoomOutBtnViewer" class="control-btn wb-tool-btn" title="Thu nhỏ">
                <i class="fas fa-search-minus"></i>
            </button>
             <button id="wbResetViewBtnViewer" class="control-btn wb-tool-btn" title="Reset góc nhìn">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button id="wbToggleGridBtnViewer" class="control-btn wb-tool-btn" title="Bật/Tắt Lưới">
                <i class="fas fa-th"></i>
            </button>
            <!-- If viewer can draw, include color and line width. Ensure IDs are unique if streamer's toolbar is also in DOM -->
            <!-- Example if viewer can draw -->
            <!--
            <label for="wbColorPickerViewer" class="wb-label">Màu:</label>
            <input type="color" id="wbColorPickerViewer" value="#FFFFFF" title="Chọn màu vẽ">
            <label for="wbLineWidthViewer" class="wb-label">Nét:</label>
            <input type="range" id="wbLineWidthViewer" min="1" max="20" value="3" title="Chọn độ dày nét vẽ">
            <span id="wbLineWidthValueViewer" class="wb-line-width-value">3</span>
            <button id="wbEraserBtnViewer" class="control-btn wb-tool-btn" title="Tẩy/Bút">
                <i class="fas fa-eraser"></i>
            </button>
             <button id="wbPanToolBtnViewer" class="control-btn wb-tool-btn" title="Di chuyển bảng">
                <i class="fas fa-arrows-alt"></i>
            </button>
            -->
        </div>
        <!-- Canvas Wrapper for the VIEWER -->
        <div id="sharedWhiteboardCanvasWrapperViewer">
            <canvas id="sharedWhiteboardCanvasViewer"></canvas>
        </div>
    </div>

    <!-- Streamer Whiteboard Overlay (Only rendered if user isHost) -->
    <% if (isHost) { %>
    <div id="sharedWhiteboardOverlayStreamer" class="whiteboard-container-overlay streamer-wb" style="display: none;">
        <div id="whiteboardToolbarStreamer" class="whiteboard-toolbar">
            <!-- Full controls for streamer -->
            <button id="wbToggleGlobalVisibilityBtn" class="control-btn wb-tool-btn" title="Bật/Tắt bảng vẽ cho mọi người">
                <i class="fas fa-eye"></i> <span class="btn-text">Hiện Bảng</span>
            </button>
            <select id="wbViewerPermissionsList" class="wb-select" title="Quyền vẽ của người xem">
                <option value="all_true">Cho phép tất cả vẽ</option>
                <option value="all_false">Không cho phép ai vẽ</option>
                <!-- Individual viewers will be populated by JS -->
            </select>

            <label for="wbColorPickerStreamer" class="wb-label">Màu:</label>
            <input type="color" id="wbColorPickerStreamer" value="#FFFFFF" title="Chọn màu vẽ">

            <label for="wbLineWidthStreamer" class="wb-label">Nét:</label>
            <input type="range" id="wbLineWidthStreamer" min="1" max="20" value="3" title="Chọn độ dày nét vẽ">
            <span id="wbLineWidthValueStreamer" class="wb-line-width-value">3</span>

            <button id="wbEraserBtnStreamer" class="control-btn wb-tool-btn" title="Chế độ Tẩy/Bút">
                <i class="fas fa-eraser"></i>
            </button>
            <button id="wbPanToolBtnStreamer" class="control-btn wb-tool-btn" title="Di chuyển bảng vẽ (Pan)">
                <i class="fas fa-arrows-alt"></i>
            </button>
            <button id="wbZoomInBtnStreamer" class="control-btn wb-tool-btn" title="Phóng to">
                <i class="fas fa-search-plus"></i>
            </button>
            <button id="wbZoomOutBtnStreamer" class="control-btn wb-tool-btn" title="Thu nhỏ">
                <i class="fas fa-search-minus"></i>
            </button>
             <button id="wbResetViewBtnStreamer" class="control-btn wb-tool-btn" title="Reset góc nhìn">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button id="wbToggleGridBtnStreamer" class="control-btn wb-tool-btn" title="Bật/Tắt Lưới">
                <i class="fas fa-th"></i>
            </button>

            <!-- Shape Tools -->
            <div class="wb-tool-dropdown-container">
                <button id="wbShapeToolToggleBtnStreamer" class="control-btn wb-tool-btn" title="Công cụ Hình dạng">
                    <i class="fas fa-shapes"></i>
                </button>
                <div id="wbShapeOptionsStreamer" class="wb-tool-options">
                    <button id="wbRectShapeBtnStreamer" class="control-btn wb-option-btn" title="Vẽ Hình chữ nhật"><i class="far fa-square"></i></button>
                    <button id="wbCircleShapeBtnStreamer" class="control-btn wb-option-btn" title="Vẽ Hình tròn"><i class="far fa-circle"></i></button>
                    <button id="wbLineShapeBtnStreamer" class="control-btn wb-option-btn" title="Vẽ Đường thẳng"><i class="fas fa-minus"></i></button>
                </div>
            </div>
            <!-- Select/Snip Tools -->
             <div class="wb-tool-dropdown-container">
                <button id="wbSelectToolToggleBtnStreamer" class="control-btn wb-tool-btn" title="Công cụ Chọn/Cắt">
                    <i class="fas fa-mouse-pointer"></i>
                </button>
                <div id="wbSnipOptionsStreamer" class="wb-tool-options">
                    <button id="wbRectangularSnipBtnStreamer" class="control-btn wb-option-btn active" title="Chọn hình chữ nhật"><i class="far fa-square"></i></button>
                    <button id="wbFreedomSnipBtnStreamer" class="control-btn wb-option-btn" title="Chọn tự do"><i class="fas fa-signature"></i></button>
                </div>
            </div>
            <button id="wbDeleteSelectedBtnStreamer" class="control-btn wb-tool-btn" title="Xóa mục đã chọn" style="display: none;">
                <i class="fas fa-trash-alt"></i>
            </button>


            <button id="wbClearBtnStreamer" class="control-btn wb-tool-btn" title="Xóa toàn bộ bảng vẽ">
                <i class="fas fa-trash"></i>
            </button>
            <button id="wbCloseBtnStreamer" class="control-btn wb-tool-btn" title="Đóng Bảng Vẽ">
                <i class="fas fa-times"></i>
            </button>
            <span id="wbCoordsDisplayStreamer" class="whiteboard-coords-display" style="display:none;"></span>
        </div>
        <div id="sharedWhiteboardCanvasWrapperStreamer">
            <canvas id="sharedWhiteboardCanvasStreamer"></canvas>
        </div>
    </div>
    <% } %>


    <!-- Viewer Quiz Overlay -->
    <div id="viewerQuizOverlay" style="display: none;">
        <button id="closeQuizOverlayBtn" title="Đóng trắc nghiệm">×</button>
        <h4 id="quizQuestionViewerText"></h4>
        <div id="quizOptionsViewerContainer">
            <%# Quiz options will be populated by JS %>
        </div>
        <div id="quizViewerFeedback"></div>
    </div>


    <script>
        // Config for liveRoom.js
        const LIVE_ROOM_CONFIG = {
            roomId: "<%= roomId %>",
            username: "<%= username %>",
            roomOwnerUsername: "<%= roomOwner %>", // Make sure this is passed from server
            peerConfig: JSON.parse('<%- JSON.stringify(peerConfig) %>'),
            glitchProjectUrl: "<%= glitchProjectUrl %>",
            userIsPro: <%= userIsPro %>,
            initialWhiteboardGloballyVisible: <%= initialWhiteboardGlobalState %>,
            initialViewerCanDraw: <%= initialViewerDrawPermission %>,
            isHost: <%= isHost %>,
        };
    </script>
    <script src="/js/alerts.js"></script>
    <script src="/js/confirm.js"></script>
    <script src="/js/sharedWhiteboard.js"></script>
    <script src="/js/liveRoom.js"></script>
</body>
</html>