<%- include('partials/header', { title: 'Các Live Stream', user: user, activePage: 'live' }) %>

<section class="live-list-section">
  <div class="container">
    <h2>Các Live Stream</h2>
    <ul id="liveList">
      <li>Đang tải danh sách live stream...</li>
    </ul>
  </div>
</section>

<script>
  // Hàm fetch danh sách live stream từ API của live-hoctap-9a3
  async function fetchLives() {
    try {
      const response = await fetch('https://live-hoctap-9a3.glitch.me/api/rooms');
      const lives = await response.json();
      const liveList = document.getElementById('liveList');
      liveList.innerHTML = ""; // Xóa nội dung ban đầu

      if (!Array.isArray(lives) || lives.length === 0) {
        liveList.innerHTML = '<li>Không có live stream nào.</li>';
      } else {
        lives.forEach(live => {
          const li = document.createElement('li');
          li.className = "live-item";
          li.innerHTML = `
            <a href="#" class="live-link" data-room-id="${live.id}">
              <strong>${live.title}</strong> 
              <span class="live-owner">(Chủ phòng: ${live.ownername})</span><br>
              <small>Đã tạo: ${new Date(live.createdAt).toLocaleString('vi-VN')}</small>
            </a>
          `;
          liveList.appendChild(li);
        });
        attachLinkHandlers();
      }
    } catch (err) {
      console.error("Lỗi khi lấy danh sách live stream:", err);
      document.getElementById('liveList').innerHTML = '<li>Lỗi khi tải dữ liệu.</li>';
    }
  }
  
  // Gắn sự kiện click cho mỗi live link để lấy token an toàn
  function attachLinkHandlers() {
    document.querySelectorAll('.live-link').forEach(link => {
      link.addEventListener('click', async function(e) {
        e.preventDefault();
        const roomId = this.getAttribute('data-room-id');
        try {
          // Gọi API nội bộ của hoctap-9a3 để lấy token
          const res = await fetch(`/live/getToken?roomId=${roomId}`);
          const data = await res.json();
          if(data.error) {
            alert("Lỗi: " + data.error);
          } else {
            // Redirect sang live server với token không hiển thị ban đầu
            window.location.href = `https://live-hoctap-9a3.glitch.me/room/${roomId}?token=${data.token}`;
          }
        } catch (error) {
          console.error(error);
          alert("Có lỗi xảy ra khi lấy token, vui lòng thử lại.");
        }
      });
    });
  }
  
  fetchLives();
</script>

<%- include('partials/footer') %>
