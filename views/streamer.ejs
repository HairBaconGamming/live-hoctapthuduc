<%# File: views/streamer.ejs %>
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer: <%= roomTitle %></title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/css/streamer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.12.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body class="streamer-body">
    <div id="streamer-particles-bg"></div>

    <header class="streamer-main-header">
        <div class="header-left">
            <i class="fas fa-video stream-icon-indicator"></i>
            <h1>Stream của: <span class="stream-title-highlight"><%= roomOwner %></span> - <%= roomTitle %></h1>
        </div>
        <div class="header-right">
            <div class="info-widget viewers">
                <i class="fas fa-users"></i>
                <span class="widget-label">Xem:</span>
                <span id="viewerCountV2" class="count-value">0</span>
            </div>
            <div class="info-widget time">
                <i class="fas fa-clock"></i>
                <span class="widget-label">Live:</span>
                <span id="streamDuration" class="time-value">00:00:00</span>
            </div>
        </div>
    </header>

    <main class="streamer-main-layout">
        <aside class="streamer-sidebar">
            <div id="controlPanelV2" class="control-panel-v2">
                <div class="panel-header">
                    <h3><i class="fas fa-cogs"></i> Bảng Điều Khiển</h3>
                    <button id="togglePanelBtnV2" class="panel-toggle-btn-v2" title="Thu gọn/Mở rộng">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="panel-content-collapsible">
                    <div id="streamPreviewContainer" class="stream-preview-container">
                        <h4><i class="fas fa-tv"></i> Xem Trước Stream</h4>
                        <div class="video-wrapper">
                            <video id="streamPreviewVideo" autoplay muted playsinline></video>
                            <div class="no-stream-overlay">Chưa có stream...</div>
                            <span id="streamStatusIndicator" class="stream-status-indicator">OFF AIR</span>
                        </div>
                    </div>

                    <div class="control-section">
                        <button id="shareScreenBtnV2" class="control-btn" data-tooltip="Chia sẻ màn hình & Âm thanh hệ thống/Mic">
                            <i class="fas fa-desktop"></i>
                            <span class="btn-label">Share MH</span>
                        </button>
                        <button id="liveCamBtnV2" class="control-btn" data-tooltip="Bật/Tắt Camera & Mic">
                            <i class="fas fa-camera-retro"></i>
                            <span class="btn-label">Camera</span>
                        </button>
                    </div>
                     <div class="control-section">
                        <button id="toggleMicBtnV2" class="control-btn mic active" data-tooltip="Bật/Tắt Micro (khi đang stream)">
                            <i class="fas fa-microphone"></i>
                            <span class="btn-label">Mic On</span>
                        </button>
                         <button id="toggleWhiteboardBtnStreamerV2" class="control-btn" data-tooltip="Bật/Tắt Bảng Vẽ Chung">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span class="btn-label">Bảng Vẽ</span>
                        </button>
                    </div>
                     <div class="control-section">
                        <button id="toggleQuizPanelBtn" class="control-btn" data-tooltip="Mở/Đóng Bảng Điều Khiển Trắc Nghiệm">
                            <i class="fas fa-question-circle"></i>
                            <span class="btn-label">Trắc Nghiệm</span>
                        </button>
                        <button id="pipChatBtnV2" class="control-btn" data-tooltip="Chat trong Picture-in-Picture (Thử nghiệm)">
                            <i class="fas fa-window-restore"></i>
                            <span class="btn-label">PiP Chat</span>
                        </button>
                    </div>


                    <div class="control-section">
                        <button id="viewersListBtnV2" class="control-btn" data-tooltip="Danh sách người xem">
                            <i class="fas fa-users-cog"></i>
                            <span class="btn-label">Người Xem</span>
                        </button>
                        <button id="bannedListBtnV2" class="control-btn" data-tooltip="Danh sách người bị chặn">
                            <i class="fas fa-user-slash"></i>
                            <span class="btn-label">Bị Chặn</span>
                        </button>
                    </div>
                     <div class="control-section">
                        <button id="endStreamBtnV2" class="control-btn end-stream" data-tooltip="Kết thúc buổi Live">
                            <i class="fas fa-power-off"></i>
                            <span class="btn-label">Kết Thúc</span>
                        </button>
                    </div>

                     <!-- Streamer Quiz Panel (initially hidden) -->
                    <div id="streamerQuizPanel">
                        <h4><i class="fas fa-tasks"></i> Tạo Trắc Nghiệm</h4>
                        <div class="quiz-question-creator">
                            <textarea id="quizQuestionText" placeholder="Nhập nội dung câu hỏi..."></textarea>
                        </div>
                        <div id="quizOptionsContainer">
                            <%# Option inputs will be added here by JS %>
                        </div>
                        <button id="addQuizOptionBtn" class="control-btn">
                            <i class="fas fa-plus-circle"></i> Thêm Lựa Chọn
                        </button>
                        <select id="quizCorrectAnswerSelect" title="Chọn đáp án đúng">
                            <%# Options populated by JS %>
                        </select>
                        <div class="quiz-controls-streamer">
                            <button id="startQuizBtn" class="control-btn"><i class="fas fa-play-circle"></i> Bắt Đầu</button>
                            <button id="showQuizAnswerBtn" class="control-btn" disabled><i class="fas fa-eye"></i> Hiện Đáp Án</button>
                            <button id="nextQuizQuestionBtn" class="control-btn" disabled><i class="fas fa-forward"></i> Câu Tiếp</button>
                            <button id="endQuizBtn" class="control-btn" disabled><i class="fas fa-stop-circle"></i> Kết Thúc</button>
                        </div>
                        <div id="quizStreamerStatus"><p>Trạng thái: Chưa bắt đầu.</p></div>
                        <div id="quizStreamerResults"></div>
                    </div>


                </div>
            </div>
        </aside>

        <section class="streamer-chat-area">
            <div class="chat-container-v2">
                <div class="panel-header chat-header"> <%# Added chat-header for potential specific styling %>
                    <h3><i class="fas fa-comments"></i> Live Chat</h3>
                </div>
                <div id="pinnedCommentV2" class="pinned-comment-v2">
                    <%# Pinned comment will be injected here by JS %>
                </div>
                <div class="chat-messages-wrapper">
                    <ul id="chatMessagesV2" class="chat-messages-list">
                        <%# Chat messages will be appended here %>
                    </ul>
                </div>
                <div class="chat-input-area-v2">
                    <div class="input-wrapper">
                        <div id="chatPreviewV2" class="chat-preview-v2 prose-styling"></div>
                        <textarea id="chatInputAreaV2" placeholder="Nhập tin nhắn (Markdown/KaTeX được hỗ trợ)..." rows="1"></textarea>
                    </div>
                    <button id="sendChatBtnV2" class="send-btn-v2" title="Gửi tin nhắn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="viewersModalV2" class="modal-v2">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close-btn" title="Đóng">×</button>
            <h3><i class="fas fa-users"></i> Danh Sách Người Xem</h3>
            <div class="modal-header">
                 <input type="text" id="viewersSearchV2" class="modal-search-input" placeholder="Tìm người xem...">
            </div>
            <div class="modal-body">
                <ul id="viewersListV2" class="user-list"></ul>
            </div>
        </div>
    </div>

    <div id="bannedModalV2" class="modal-v2">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <button class="modal-close-btn" title="Đóng">×</button>
            <h3><i class="fas fa-user-slash"></i> Danh Sách Đã Chặn</h3>
            <div class="modal-body">
                <ul id="bannedListV2" class="user-list"></ul>
            </div>
        </div>
    </div>

    <!-- Whiteboard Overlay Container -->
    <div id="whiteboardContainerOverlayV2" class="whiteboard-container-overlay">
        <div id="whiteboardToolbarV2" class="whiteboard-toolbar">
            <label for="wbColorPickerV2" class="wb-label">Màu:</label>
            <input type="color" id="wbColorPickerV2" value="#FFFFFF" title="Chọn màu vẽ">

            <label for="wbLineWidthRangeV2" class="wb-label">Nét:</label>
            <input type="range" id="wbLineWidthRangeV2" min="1" max="20" value="3" title="Chọn độ dày nét vẽ">
            <span id="wbLineWidthValueV2" class="wb-line-width-value">3</span>

            <button id="wbEraserModeBtnV2" class="control-btn wb-tool-btn" title="Chế độ Tẩy/Bút">
                <i class="fas fa-eraser"></i>
            </button>
            <button id="wbPanToolBtnV2Streamer" class="control-btn wb-tool-btn" title="Di chuyển bảng vẽ (Pan)">
                <i class="fas fa-arrows-alt"></i>
            </button>
            <button id="wbZoomInBtnV2Streamer" class="control-btn wb-tool-btn" title="Phóng to">
                <i class="fas fa-search-plus"></i>
            </button>
            <button id="wbZoomOutBtnV2Streamer" class="control-btn wb-tool-btn" title="Thu nhỏ">
                <i class="fas fa-search-minus"></i>
            </button>
             <button id="wbResetViewBtnV2Streamer" class="control-btn wb-tool-btn" title="Reset góc nhìn">
                <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button id="wbToggleGridBtnV2Streamer" class="control-btn wb-tool-btn" title="Bật/Tắt Lưới">
                <i class="fas fa-th"></i>
            </button>

            <!-- Shape Tools -->
            <div class="wb-tool-dropdown-container">
                <button id="wbShapeToolBtnV2Streamer" class="control-btn wb-tool-btn" title="Công cụ Hình dạng">
                    <i class="fas fa-shapes"></i>
                </button>
                <div id="wbShapeOptionsContainerV2Streamer" class="wb-tool-options">
                    <button id="wbDrawRectangleBtnV2Streamer" class="control-btn wb-option-btn" title="Vẽ Hình chữ nhật"><i class="far fa-square"></i></button>
                    <button id="wbDrawCircleBtnV2Streamer" class="control-btn wb-option-btn" title="Vẽ Hình tròn"><i class="far fa-circle"></i></button>
                    <button id="wbDrawLineBtnV2Streamer" class="control-btn wb-option-btn" title="Vẽ Đường thẳng"><i class="fas fa-minus"></i></button>
                </div>
            </div>
            <!-- Select/Snip Tools -->
             <div class="wb-tool-dropdown-container">
                <button id="wbSelectToolBtnV2Streamer" class="control-btn wb-tool-btn" title="Công cụ Chọn/Cắt">
                    <i class="fas fa-mouse-pointer"></i> <!-- Or fa-vector-square -->
                </button>
                <div id="wbSnipModeOptionsContainerV2Streamer" class="wb-tool-options">
                    <button id="wbRectangularSnipBtnV2Streamer" class="control-btn wb-option-btn active" title="Chọn hình chữ nhật"><i class="far fa-square"></i></button>
                    <button id="wbFreedomSnipBtnV2Streamer" class="control-btn wb-option-btn" title="Chọn tự do"><i class="fas fa-signature"></i></button>
                </div>
            </div>
            <button id="wbDeleteSelectedBtnV2Streamer" class="control-btn wb-tool-btn" title="Xóa mục đã chọn" style="display: none;">
                <i class="fas fa-trash-alt"></i>
            </button>


            <button id="wbClearBtnV2" class="control-btn wb-tool-btn" title="Xóa toàn bộ bảng vẽ">
                <i class="fas fa-trash"></i>
            </button>
            <button id="closeWhiteboardBtnV2" class="control-btn wb-tool-btn" title="Đóng Bảng Vẽ">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <canvas id="whiteboardCanvasV2"></canvas>
        <div id="streamerCoordsDisplay"></div>
    </div>
    
    <!-- Hidden video element for PiP Chat -->
    <video id="pipChatVideoPlayer" style="display:none;" playsinline muted></video>


    <script>
        const streamerConfig = {
            roomId: "<%= roomId %>",
            username: "<%= username %>",
            roomOwner: "<%= roomOwner %>", // Assuming owner username is passed
            roomCreatedAt: new Date("<%= roomCreatedAt %>"), // Ensure this is a valid Date string
            peerConfig: JSON.parse('<%- JSON.stringify(peerConfig) %>'), // Pass PeerJS config securely
            glitchProjectUrl: "<%= glitchProjectUrl %>",
            reduceMotionParticles: false // Example: allow particles even if OS prefers reduced motion
        };
    </script>
    <script src="/js/alerts.js"></script>
    <script src="/js/confirm.js"></script>
    <script src="/js/sharedWhiteboard.js"></script>
    <script src="/js/streamer.js"></script>
</body>
</html>