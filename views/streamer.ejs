<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√≠ live - <%= room.title %></title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://gc.kis.v2.scr.kaspersky-labs.com wss://gc.kis.v2.scr.kaspersky-labs.com;">
  <link rel="stylesheet" href="/css/streamer.css">
  <link rel="icon" type="image/png" href="https://cdn.glitch.global/71030012-56ea-4d26-a426-e0099201df1c/823029_library_512x512.png?v=1741523759119">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Load Marked ƒë·ªÉ x·ª≠ l√Ω Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Load KaTeX ƒë·ªÉ render c√¥ng th·ª©c to√°n h·ªçc -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
</head>
<body>
  <input type="hidden" id="username" value="<%= user.username %>">
  <div class="live-header">
    <div class="live-left">
      <h1 class="live-title">
        <i class="fas fa-video"></i>
        Live Stream: <span class="stream-title"><%= room.title %></span>
      </h1>
    </div>
    <div class="live-right">
      <p class="viewer-info">
        <span class="viewer-icon">üëÄ</span> Ng∆∞·ªùi xem: 
        <span id="viewerCount" class="viewer-count">0</span> | 
        Th·ªùi gian m·ªü: <span id="openTime">00:00:00</span>
      </p>
    </div>
  </div>
  <div class="container">
    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
      <button id="togglePanelBtn" class="panel-toggle-btn">
        <i class="fas fa-chevron-up"></i>
      </button>
      <div id="screenShareContainer">
        <h3>Screen Share Preview</h3>
        <video id="screenShareVideo" autoplay muted playsinline></video>
      </div>
      <div class="panel-content">
        <button id="endStreamBtn"><i class="fas fa-power-off"></i> K·∫øt th√∫c live</button>
        <button id="shareScreenBtn"><i class="fas fa-desktop"></i> Chia s·∫ª m√†n h√¨nh</button>
        <button id="liveCamBtn"><i class="fas fa-camera"></i> Live Cam</button>
        <button id="toggleMicBtn"><i class="fas fa-microphone"></i> Mic On</button>
      </div>
      <div class="panel-content">
        <button id="bannedListBtn"><i class="fas fa-ban"></i> Danh s√°ch Ban</button>
        <button id="viewersListBtn"><i class="fas fa-users"></i> Danh s√°ch Viewers</button>
      </div>
    </div>
    <!-- Chat Box -->
    <div id="pinnedComment" class="pinned-comment"></div>
    <div id="chatBox">
      <h3>üí¨ Chat tr·ª±c ti·∫øp v·ªõi ng∆∞·ªùi xem</h3>
      <ul id="chatMessages"></ul>
      <button id="pipChatBtn">
        <i class="fas fa-window-restore"></i>
      </button>
      <!-- Enhanced Chat Input -->
      <div class="chat-input-container">
        <textarea id="chatInputArea" placeholder="Nh·∫≠p tin nh·∫Øn... (H·ªó tr·ª£ Markdown v√† KaTeX)"></textarea>
        <button id="sendChatBtn">G·ª≠i</button>
      </div>
      <!-- Chat Preview -->
      <div id="chatPreview" class="chat-preview"></div>
    </div>
  </div>
  <canvas id="pipChatCanvas" width="400" height="600" style="display: none;"></canvas>
  <div id="bannedModal" class="banned-modal">
    <div class="banned-modal-overlay">
      <div class="banned-modal-box">
        <h3>Danh s√°ch Viewer B·ªã Ban</h3>
        <ul id="bannedList"></ul>
        <button id="closeBannedModal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
  <!-- Modal Viewers List -->
  <div id="viewersModal" class="viewers-modal">
    <div class="viewers-modal-overlay">
      <div class="viewers-modal-box">
        <h3>Danh s√°ch Viewers</h3>
        <input type="text" id="viewersSearch" placeholder="T√¨m ki·∫øm viewer..." />
        <ul id="viewersList"></ul>
        <button id="closeViewersModal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <!-- C√°c bi·∫øn t·ª´ EJS -->
  <script>
    const roomId = "<%= room.id %>";
    const username = document.getElementById("username").value || "<%= user.username %>";
    const roomCreatedAt = new Date("<%= room.createdAt %>");
    // Gi·∫£ s·ª≠ room.owner ch·ª©a username c·ªßa host
    const roomOwner = "<%= room.owner %>";
    // ƒê·ªëi t∆∞·ª£ng user c√≥ thu·ªôc t√≠nh isPro
    const user = {
      username: "<%= user.username %>",
      isPro: <%= user.isPro ? "true" : "false" %>
    };

    function updateOpenTime() {
      const now = new Date();
      const diff = now - roomCreatedAt;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      document.getElementById("openTime").textContent =
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    setInterval(updateOpenTime, 1000);
    updateOpenTime();
  </script>
  <script src="/js/streamer.js"></script>
</body>
</html>
